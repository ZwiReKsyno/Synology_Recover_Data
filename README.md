# Восстановление данных Synology на ПК

### Описание

Скрипт, упрощающий восстановление данных с дисков Synology с помощью компьютера.

Теперь поддерживает зашифрованные тома.


### Подтверждено!!

<details>
  <summary>Нажмите здесь, чтобы увидеть список</summary>

| Drive source | DSM version    | Btrfs/Ext | Storage Pool type | RAID  | Encrypted | Notes           |
|--------------|----------------|-----------|-------------------|-------|-----------|-----------------|
| DS720+       | 7.2.1 Update 4 | Btrfs     | Multiple Volume   | SHR   | Volume    | Single drive    |
| DS720+       | 7.2.1 Update 4 | Btrfs     | Multiple Volume   | SHR   | no        | Single drive    |
| DS1812+      | 6.2.4 Update 7 | Btrfs     | Multiple Volume   | SHR   | no        | Single drive    |
| DS1812+      | 6.2.4 Update 7 | Btrfs     | Single Volume     | Basic | no        | **Неисправный, неисправный жесткий диск** |

</details>


### Что делает скрипт?

Сценарий автоматически выполняет шаги с 4 по 15 с этой веб-страницы: <br>
https://kb.synology.com/en-id/DSM/tutorial/How_can_I_recover_data_from_my_DiskStation_using_a_PC

Итак, вам нужно выполнить шаги с 1 по 3 на этой веб-странице.

Применяются те же правила среды, что и на веб-странице Synology:

**Применимый к::**
- DSM версии 6.2.x и выше
- Тома, использующие файловые системы Btrfs или ext4.
- Зашифрованные тома с использованием файловых систем Btrfs или ext4.
- Только Ubuntu 19.10 (Eoan Ermine) (рекомендованная Synology **версия 18.04 содержит ошибку с постоянным разделом**)

**Не применимо к::**
- Тома, использующие кэш SSD для чтения и записи

**На данный момент скрипт НЕ поддерживает::**
- Зашифрованные общие папки

На данный момент скрипт поддерживает одновременное монтирование только одного тома. Вам нужно будет снова запустить сценарий, чтобы смонтировать второй том.


### Настройка для восстановления данных с помощью ПК

1. Убедитесь, что на вашем компьютере достаточно слотов для установки накопителей (вы можете использовать док-станцию ​​USB).
2. Извлеките диски из Synology NAS и установите их на компьютер или USB-док-станцию. Для конфигураций RAID или SHR необходимо одновременно установить все диски (за исключением дисков горячего резерва) на компьютер.
3. Загрузите образ рабочего стола для [Ubuntu version 19.10 Eoan Ermine](https://old-releases.ubuntu.com/releases/19.10/)
   - Рекомендуемая Synology версия 18.04 содержит ошибку с постоянным разделом, поэтому любые изменения, внесенные вами в Ubuntu, будут потеряны при выключении Ubuntu.
   - Для более новых версий Ubuntu, таких как 20.04.6 LTS и 22.04.4 LTS, требуется USB-накопитель емкостью 8 ГБ и установка версии mdadm, которая не будет работать с местоположением суперблока DSM.
4. Вам понадобится USB-накопитель емкостью 4 ГБ или больше.
5. Подготовьте среду Ubuntu, следуя инструкциям в  [этом руководстве,](https://ubuntu.com/tutorials/create-a-usb-stick-on-windows) за одним исключением:
    - Установите размер постоянного раздела в [Rufus](https://rufus.ie/en/) больше 0, чтобы любые изменения, внесенные вами в Ubuntu, сохранялись на USB-накопителе.
    <p align="left"> &nbsp; &nbsp;<img src="/images/rufus.png"></p>
6. Если диски содержат зашифрованный том или тома:
    - Найдите свой [NASNAME]_volume#.rkey для каждого зашифрованного тома. например MYNAS_volume1.rkey, DISKSTATION_volume1.rkey или RACKSTATION_volume1.rkey и т. д.
    - Скопируйте файл или файлы *.rkey на USB-накопитель или в сетевую папку.
7. Как только Руфус завершит создание загрузочного диска, вы можете перезагрузить компьютер, [войти в BIOS](https://www.tomshardware.com/reviews/bios-keys-to-access-your-firmware,5732.html) настроить его на загрузку с USB-накопителя и загрузиться в Ubuntu.
    - Я настоятельно рекомендую отключать кабели SATA от дисков ПК, пока компьютер выключен, чтобы случайно не установить на них Ubuntu.
8. **ВАЖНО!** Когда Ubuntu спросит, хотите ли вы «ЗАПУСТИТЬ Ubuntu» или «Установить Ubuntu», выберите « ЗАПУСТИТЬ Ubuntu ».

### Дополнительные действия, если том зашифрован

После загрузки в Ubuntu:
1. Подключите USB-накопитель, содержащий файл или файлы *.rkey, или перейдите к общей сетевой папке, где расположены файл или файлы *.rkey..
3. Скопируйте файл или файлы *.rkey на главную.

### Настройка в Ubuntu

1. Откройте Firefox на панели инструментов, перейдите по адресу и загрузите zip-файл https://tinyurl.com/synorecover
2.Откройте «Файлы» на панели инструментов и нажмите «Загрузки», щелкните правой кнопкой мыши zip-файл и выберите «Извлечь».
3. Щелкните правой кнопкой мыши файл syno_restore_data.sh и выберите «Свойства».
    - Нажмите Разрешения.
    - Установите флажок Разрешить выполнение файла как программы.
    <p align="left"> &nbsp; <img src="/images/script-permissions-2.png"></p>
4. Скопируйте syno_recover_data.sh на 1 уровень вверх, домой
    <p align="left"> &nbsp; <img src="/images/home.png"></p>
5. Нажмите значок «Показать приложения» в левом нижнем углу рабочего стола.
6. Введите терминал в строке поиска.
7. Щелкните правой кнопкой мыши «Терминал» и выберите «Сохранить в избранное».
8. Дважды нажмите Esc, чтобы вернуться на рабочий стол.


### Запуск сценария

1. Откройте Терминал с панели инструментов.
2. Введите  `sudo -i /home/ubuntu/syno_recover_data.sh` и нажмите Enter.
    <p align="left"> &nbsp; <img src="/images/run-script.png"></p>


### Доступ к вашим данным

Доступ к вашим данным можно получить двумя способами:

- Доступ к тому из домашней папки
<p align="left"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <img src="/images/volume_in_home-2.png"></p>

- Доступ к тому из раздела «Медиа» на панели инструментов
<p align="left"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <img src="/images/volume_in_media-4.png"></p>

<br>


---
### Скриншоты

<p align="left">DSM 7 с двумя пулами хранения и томами</p>
<p align="left"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <img src="/images/image-volume_2-2.png"></p>

<br>

<p align="left">DSM 7 SHR, один том</p>
<p align="left"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <img src="/images/image-vg1000-2.png"></p>

<br>

<p align="left">DSM 6 Classic RAID, один томe</p>
<p align="left"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <img src="/images/image-md-2.png"></p>

<br>

<p align="left">Зашифрованный том DSM 7</p>
<p align="left"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <img src="/images/image-encrypted-volume-2.png"></p>

